<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Create Invoice</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div th:replace="~{fragments/navbar :: navbar}"></div>
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight"
          th:text="${invoice.id} != null ? 'Edit Invoice' : 'Create Invoice'">
        Create Invoice
      </h1>
      <p class="text-sm text-gray-600 mt-1">Fill out invoice details and billing address, then save.</p>
    </header>

    <form th:action="@{/invoices}" th:object="${invoice}" method="post" class="space-y-6">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input type="hidden" th:field="*{id}" />

      <!-- Invoice Details -->
      <section class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Invoice Details</h2>

          <!-- Show number only if already assigned -->
          <div th:if="*{invoiceNumber != null and !#strings.isEmpty(invoiceNumber)}"
               class="inline-flex items-center gap-2 text-sm">
            <span class="text-gray-600">Number:</span>
            <span class="px-2.5 py-1 rounded-md bg-indigo-50 text-indigo-700 font-medium"
                  th:text="*{invoiceNumber}">2025-000001</span>
          </div>

          <!-- If new / not assigned yet -->
          <div th:if="*{invoiceNumber == null or #strings.isEmpty(invoiceNumber)}"
               class="text-sm text-gray-500">
            Number will be generated on save
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="col-span-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Service Date</label>
            <input type="date" th:field="*{serviceDate}"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>

          <div class="col-span-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date</label>
            <input type="date" th:field="*{invoiceDate}"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>

          <div class="md:col-span-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Entry Text</label>
            <textarea th:field="*{entryText}" rows="3" placeholder="Optional introduction/notes"
                      class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
        </div>
      </section>

      <!-- Billing address -->
      <section class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Billing Address</h2>
          <a th:href="@{/invoices/select-customer}" class="text-sm text-indigo-600 hover:text-indigo-700">Choose customerâ€¦</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
            <input th:field="*{billCompanyName}" placeholder="Company name"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            <input th:field="*{billPhoneNumber}" placeholder="+49 ..."
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Address Line 1</label>
            <input th:field="*{billLine1}" placeholder="Street & number"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Address Line 2</label>
            <input th:field="*{billLine2}" placeholder="Apt / Suite / Floor (optional)"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
            <input th:field="*{billPostalCode}" placeholder="e.g., 10115"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
            <input th:field="*{billCity}" placeholder="Berlin"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Country Code</label>
            <input th:field="*{billCountryCode}" placeholder="DE"
                   class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 uppercase" />
          </div>
        </div>
      </section>

<!-- Line items (re-added, dynamic, Tailwind) -->
<section class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-medium">Line Items</h2>
      <button type="button" id="add-item-btn"
              class="inline-flex items-center gap-2 px-3 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50">
        + Add item
      </button>
    </div>
  
    <!-- Table header -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 text-sm font-medium text-gray-700 mb-2">
      <div class="md:col-span-6">Description</div>
      <div class="md:col-span-2">Qty</div>
      <div class="md:col-span-2">Unit (net)</div>
      <div class="md:col-span-2 text-right">Actions</div>
    </div>
  
    <div id="items-container" class="space-y-3">
      <!-- Existing items (server-rendered) -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start border rounded-lg p-3"
           th:each="item,iter : *{items}">
        <!-- keep id hidden so edits update instead of creating new -->
        <input type="hidden" th:name="${'items[' + iter.index + '].id'}" th:value="${item.id}" />
        <!-- description -->
        <div class="md:col-span-6">
          <input th:name="${'items[' + iter.index + '].description'}"
                 th:value="${item.description}"
                 placeholder="Service description"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <!-- quantity -->
        <div class="md:col-span-2">
          <input type="number" step="0.001" min="0"
                 th:name="${'items[' + iter.index + '].quantity'}"
                 th:value="${item.quantity}"
                 placeholder="0"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <!-- unit net -->
        <div class="md:col-span-2">
          <input type="number" step="0.01" min="0"
                 th:name="${'items[' + iter.index + '].unitNetAmount'}"
                 th:value="${item.unitNetAmount}"
                 placeholder="0.00"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <!-- actions -->
        <div class="md:col-span-2 flex justify-end">
          <button type="button" class="remove-item inline-flex items-center px-3 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50">
            Remove
          </button>
        </div>
      </div>
    </div>
  
    <!-- Template for new rows (client adds) -->
    <template id="item-row-template">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start border rounded-lg p-3">
        <input type="hidden" name="items[__index__].id" />
        <div class="md:col-span-6">
          <input name="items[__index__].description"
                 placeholder="Service description"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <div class="md:col-span-2">
          <input type="number" step="0.001" min="0" name="items[__index__].quantity"
                 placeholder="0"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <div class="md:col-span-2">
          <input type="number" step="0.01" min="0" name="items[__index__].unitNetAmount"
                 placeholder="0.00"
                 class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
        <div class="md:col-span-2 flex justify-end">
          <button type="button" class="remove-item inline-flex items-center px-3 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50">
            Remove
          </button>
        </div>
      </div>
    </template>
  </section>
  

  
      <section class="flex items-center justify-end gap-3">
        <a th:href="@{/invoices/select-customer}"
           class="inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
          Cancel
        </a>
        <button type="submit"
                class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600">
          Save Invoice
        </button>
      </section>
    </form>
  </main>

</body>
</html>
  <script th:inline="javascript">
    (() => {
      const container = document.getElementById('items-container');
      const addBtn = document.getElementById('add-item-btn');
      const rowTpl = document.getElementById('item-row-template').innerHTML;
  
      let nextIndex = /*[[${#lists.size(invoice.items)}]]*/ 0;
  
      function wireRowEvents(rowEl) {
        const removeBtn = rowEl.querySelector('.remove-item');
        removeBtn?.addEventListener('click', () => {
          rowEl.remove();
          renumber();
        });
      }
  
      function addRow() {
        const html = rowTpl.replaceAll('__index__', String(nextIndex));
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html.trim();
        const rowEl = wrapper.firstElementChild;
        container.appendChild(rowEl);
        wireRowEvents(rowEl);
        nextIndex++;
      }
  
      function renumber() {
        const rows = Array.from(container.children);
        rows.forEach((row, i) => {
          row.querySelectorAll('input, select, textarea').forEach((el) => {
            const name = el.getAttribute('name');
            if (!name) return;
            el.setAttribute('name', name.replace(/items\[\d+]/, `items[${i}]`));
          });
        });
        nextIndex = rows.length;
      }
  
      Array.from(container.children).forEach(wireRowEvents);
  
      addBtn?.addEventListener('click', addRow);
    })();
  </script>